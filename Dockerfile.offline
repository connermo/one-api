# One API ç¦»çº¿ç‰ˆæœ¬ Dockerfile
# æ­¤ç‰ˆæœ¬åœ¨æ„å»ºæ—¶é¢„ä¸‹è½½æ‰€æœ‰tiktokenç¼“å­˜ï¼Œç”Ÿæˆå®Œå…¨ç¦»çº¿çš„é•œåƒ

FROM --platform=$BUILDPLATFORM node:16 AS builder

WORKDIR /web
COPY ./VERSION .
COPY ./web .

# å¹¶è¡Œæ„å»ºæ‰€æœ‰å‰ç«¯ä¸»é¢˜
RUN npm install --prefix /web/default & \
    npm install --prefix /web/berry & \
    npm install --prefix /web/air & \
    wait

RUN DISABLE_ESLINT_PLUGIN='true' REACT_APP_VERSION=$(cat ./VERSION) npm run build --prefix /web/default & \
    DISABLE_ESLINT_PLUGIN='true' REACT_APP_VERSION=$(cat ./VERSION) npm run build --prefix /web/berry & \
    DISABLE_ESLINT_PLUGIN='true' REACT_APP_VERSION=$(cat ./VERSION) npm run build --prefix /web/air & \
    wait

FROM golang:alpine AS builder2

RUN apk add --no-cache \
    gcc \
    musl-dev \
    sqlite-dev \
    build-base \
    curl \
    wget

ENV GO111MODULE=on \
    CGO_ENABLED=1 \
    GOOS=linux

WORKDIR /build

# å¤åˆ¶Goæ¨¡å—æ–‡ä»¶å¹¶ä¸‹è½½ä¾èµ–
ADD go.mod go.sum ./
RUN go mod download

# å¤åˆ¶æ‰€æœ‰æºä»£ç 
COPY . .
COPY --from=builder /web/build ./web/build

# è®¾ç½®tiktokenç¼“å­˜ç›®å½•
ENV TIKTOKEN_CACHE_DIR=/build/tiktoken_cache
ENV DATA_GYM_CACHE_DIR=/build/tiktoken_cache
RUN mkdir -p /build/tiktoken_cache

# ç›´æ¥ä¸‹è½½tiktokenç¼“å­˜æ–‡ä»¶
RUN echo "ğŸŒ ä¸‹è½½ tiktoken ç¼“å­˜æ–‡ä»¶..." && \
    cd /build/tiktoken_cache && \
    BASE_URL="https://openaipublic.blob.core.windows.net/encodings" && \
    FILES="r50k_base.tiktoken p50k_base.tiktoken cl100k_base.tiktoken o200k_base.tiktoken" && \
    SUCCESS_COUNT=0 && \
    for file in $FILES; do \
        echo "ğŸ“¥ ä¸‹è½½ $file ..."; \
        if curl -L -o "$file" "$BASE_URL/$file" 2>/dev/null; then \
            if [ -s "$file" ]; then \
                echo "âœ… $file ä¸‹è½½æˆåŠŸ ($(stat -f%z "$file" 2>/dev/null || stat -c%s "$file") bytes)"; \
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1)); \
            else \
                echo "âŒ $file ä¸‹è½½å¤±è´¥ï¼ˆæ–‡ä»¶ä¸ºç©ºï¼‰"; \
                rm -f "$file"; \
            fi; \
        else \
            echo "âŒ $file ä¸‹è½½å¤±è´¥"; \
        fi; \
    done && \
    echo "ğŸ“Š æ€»å…±ä¸‹è½½æˆåŠŸ $SUCCESS_COUNT ä¸ªæ–‡ä»¶" && \
    echo "ğŸ’¾ ç¼“å­˜ç›®å½•å¤§å°: $(du -sh . | cut -f1)" && \
    ls -la

# ç¼–è¯‘ä¸»ç¨‹åº
RUN echo "ğŸ”¨ ç¼–è¯‘ One API..." && \
    go build -trimpath -ldflags "-s -w -X 'github.com/connermo/one-api/common.Version=$(cat VERSION)' -linkmode external -extldflags '-static'" -o one-api

FROM alpine:latest

# å®‰è£…å¿…è¦çš„ç³»ç»ŸåŒ…
RUN apk add --no-cache ca-certificates tzdata wget

# å¤åˆ¶ç¼–è¯‘å¥½çš„ç¨‹åº
COPY --from=builder2 /build/one-api /

# å¤åˆ¶tiktokenç¼“å­˜æ–‡ä»¶
COPY --from=builder2 /build/tiktoken_cache /tiktoken_cache

# è®¾ç½®tiktokenç¼“å­˜ç¯å¢ƒå˜é‡
ENV TIKTOKEN_CACHE_DIR=/tiktoken_cache
ENV DATA_GYM_CACHE_DIR=/tiktoken_cache

# è®¾ç½®å…¶ä»–ç¦»çº¿ç¯å¢ƒå˜é‡
ENV MEMORY_CACHE_ENABLED=true
ENV TZ=Asia/Shanghai

# åˆ›å»ºæ•°æ®ç›®å½•
RUN mkdir -p /data && chmod 755 /data

# éªŒè¯tiktokenç¼“å­˜æ–‡ä»¶
RUN echo "ğŸ” éªŒè¯tiktokenç¼“å­˜æ–‡ä»¶..." && \
    ls -la /tiktoken_cache/ && \
    echo "ğŸ’¾ æ€»ç¼“å­˜å¤§å°: $(du -sh /tiktoken_cache | cut -f1)"

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD wget --quiet --tries=1 --spider http://localhost:3000/api/status || exit 1

EXPOSE 3000
WORKDIR /data

# å¯åŠ¨å‘½ä»¤
ENTRYPOINT ["/one-api"] 